apiVersion: v1
kind: Namespace
metadata:
  name: easyscale-system
  labels:
    app.kubernetes.io/name: easyscale
    app.kubernetes.io/component: system

---

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: scalingrules.easyscale.io
  labels:
    app.kubernetes.io/name: easyscale
    app.kubernetes.io/component: crd
spec:
  group: easyscale.io
  names:
    kind: ScalingRule
    listKind: ScalingRuleList
    plural: scalingrules
    singular: scalingrule
    shortNames:
      - sr
      - scalerule
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: ScalingRule defines time-based scaling rules for Kubernetes workloads
          required:
            - spec
          properties:
            spec:
              type: object
              description: Specification of the scaling rule
              required:
                - target
                - schedule
                - default
              properties:
                target:
                  type: object
                  description: Target workload to scale
                  required:
                    - kind
                    - name
                    - namespace
                  properties:
                    kind:
                      type: string
                      description: Workload kind (Deployment or StatefulSet)
                      enum:
                        - Deployment
                        - StatefulSet
                    name:
                      type: string
                      description: Name of the workload
                      minLength: 1
                    namespace:
                      type: string
                      description: Namespace of the workload
                      minLength: 1

                schedule:
                  type: array
                  description: List of schedule rules
                  minItems: 1
                  items:
                    type: object
                    required:
                      - name
                      - replicas
                    properties:
                      name:
                        type: string
                        description: Human-readable name for this rule
                        minLength: 1
                      days:
                        type: array
                        description: Days of week when this rule applies
                        items:
                          type: string
                          enum:
                            - Monday
                            - Tuesday
                            - Wednesday
                            - Thursday
                            - Friday
                            - Saturday
                            - Sunday
                      dates:
                        type: array
                        description: Specific dates when this rule applies (YYYY-MM-DD)
                        items:
                          type: string
                          pattern: '^\d{4}-\d{2}-\d{2}$'
                      time_ranges:
                        type: array
                        description: Time ranges when this rule applies
                        items:
                          type: object
                          required:
                            - start
                            - end
                          properties:
                            start:
                              type: string
                              description: Start time (HH:MM format)
                              pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
                            end:
                              type: string
                              description: End time (HH:MM format)
                              pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
                      replicas:
                        type: integer
                        description: Desired number of replicas
                        minimum: 0
                      priority:
                        type: integer
                        description: Priority for conflict resolution (higher wins)
                        default: 0
                      timezone:
                        type: string
                        description: Timezone for this rule (IANA timezone name)
                        default: "UTC"

                default:
                  type: object
                  description: Default configuration when no schedule matches
                  required:
                    - replicas
                  properties:
                    replicas:
                      type: integer
                      description: Default number of replicas
                      minimum: 0

                limits:
                  type: object
                  description: Optional safety limits
                  properties:
                    min_replicas:
                      type: integer
                      description: Minimum allowed replicas
                      minimum: 0
                    max_replicas:
                      type: integer
                      description: Maximum allowed replicas
                      minimum: 1

                timezone:
                  type: string
                  description: Default timezone for all rules (IANA timezone name)
                  default: "UTC"

            status:
              type: object
              description: Status of the scaling rule
              properties:
                lastAppliedRule:
                  type: string
                  description: Name of the last applied schedule rule
                lastScalingTime:
                  type: string
                  format: date-time
                  description: Time of last scaling operation
                currentReplicas:
                  type: integer
                  description: Current number of replicas
                desiredReplicas:
                  type: integer
                  description: Desired number of replicas
                conditions:
                  type: array
                  description: Conditions of the scaling rule
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: Condition type
                      status:
                        type: string
                        description: Condition status (True/False/Unknown)
                        enum:
                          - "True"
                          - "False"
                          - "Unknown"
                      reason:
                        type: string
                        description: Reason for the condition
                      message:
                        type: string
                        description: Human-readable message
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: Last time the condition transitioned

      subresources:
        status: {}

      additionalPrinterColumns:
        - name: Target
          type: string
          description: Target workload
          jsonPath: .spec.target.kind
        - name: Name
          type: string
          description: Target name
          jsonPath: .spec.target.name
        - name: Namespace
          type: string
          description: Target namespace
          jsonPath: .spec.target.namespace
        - name: Current
          type: integer
          description: Current replicas
          jsonPath: .status.currentReplicas
        - name: Desired
          type: integer
          description: Desired replicas
          jsonPath: .status.desiredReplicas
        - name: Last Rule
          type: string
          description: Last applied rule
          jsonPath: .status.lastAppliedRule
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: easyscale
  namespace: easyscale-system
  labels:
    app.kubernetes.io/name: easyscale
    app.kubernetes.io/component: controller

---

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: easyscale-controller
  labels:
    app.kubernetes.io/name: easyscale
    app.kubernetes.io/component: controller
rules:
  # Read namespaces (for API health check)
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]

  # Read Deployments and StatefulSets
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets"]
    verbs: ["get", "list", "watch"]

  # Read pods for current replica count
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Scale Deployments and StatefulSets
  - apiGroups: ["apps"]
    resources: ["deployments/scale", "statefulsets/scale"]
    verbs: ["get", "update", "patch"]

  # Read ConfigMaps for rules (if using ConfigMap-based rules)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Create Events for audit trail
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # CRD access (for ScalingRule custom resources)
  - apiGroups: ["easyscale.io"]
    resources: ["scalingrules"]
    verbs: ["get", "list", "watch"]

  - apiGroups: ["easyscale.io"]
    resources: ["scalingrules/status"]
    verbs: ["get", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: easyscale-controller
  labels:
    app.kubernetes.io/name: easyscale
    app.kubernetes.io/component: controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: easyscale-controller
subjects:
  - kind: ServiceAccount
    name: easyscale
    namespace: easyscale-system

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: easyscale-controller
  namespace: easyscale-system
  labels:
    app.kubernetes.io/name: easyscale
    app.kubernetes.io/component: controller
    app.kubernetes.io/version: "0.1.0"
spec:
  replicas: 1
  strategy:
    type: Recreate  # Only one instance should run at a time
  selector:
    matchLabels:
      app.kubernetes.io/name: easyscale
      app.kubernetes.io/component: controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: easyscale
        app.kubernetes.io/component: controller
        app.kubernetes.io/version: "0.1.0"
    spec:
      serviceAccountName: easyscale
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: controller
          image: resulyrt93/easyscale:latest
          imagePullPolicy: Always

          # Command override - point to rules directory
          command: ["python", "-m", "easyscale"]
          args:
            - "--rules-dir=/etc/easyscale/rules"
            - "--check-interval=60"
            - "--cooldown=60"
            - "--log-level=INFO"
            - "--log-format=json"

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

          # Volume mounts for rules
          volumeMounts:
            - name: rules
              mountPath: /etc/easyscale/rules
              readOnly: true
            - name: tmp
              mountPath: /tmp

          # Health probes
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "import sys; sys.exit(0)"
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - python
                - -c
                - "import sys; sys.exit(0)"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: PYTHONDONTWRITEBYTECODE
              value: "1"
            - name: TZ
              value: "UTC"

      volumes:
        - name: rules
          configMap:
            name: easyscale-rules
            optional: true
        - name: tmp
          emptyDir: {}

      # Scheduling preferences
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: easyscale
                    app.kubernetes.io/component: controller
                topologyKey: kubernetes.io/hostname

      # Tolerate control plane taints if needed
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule
